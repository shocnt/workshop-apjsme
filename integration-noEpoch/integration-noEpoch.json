{"status":{},"product_version":"2.7.1.2","spec":{"description":"app access: http:\/\/@@{app.address}@@:8000\n\ndbname: @@{Era.DB_ENTITY_NAME}@@\n","resources":{"client_attrs":{"None":{"y":443,"x":658.75},"0f21b5e2_deployment":{"y":11.5,"x":674.6171875},"17264844_deployment":{"y":-294.9787719025,"x":472.7787478433},"f6be2786_deployment":{"y":11,"x":452.75},"f9a4c530_deployment":{"y":9,"x":219}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0bfadcbf_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"975ed99a_runbook","main_task_local_reference":{"kind":"app_task","name":"0bfadcbf_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Flow Del Category"}],"name":"9ade3d68_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Flow Del Category","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"c8712657_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"cf884050_runbook","main_task_local_reference":{"kind":"app_task","name":"9ade3d68_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1124d60e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6bcf94d3_runbook","main_task_local_reference":{"kind":"app_task","name":"1124d60e_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0ae24e3c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"84c12573_runbook","main_task_local_reference":{"kind":"app_task","name":"0ae24e3c_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bf858e3b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6e2e5ff2_runbook","main_task_local_reference":{"kind":"app_task","name":"bf858e3b_dag"},"variable_list":[]},"name":"action_stop"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Del Category Value"}],"name":"306b2064_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Del Category Value","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\nuuid = \"@@{DB_SERVER_VM_UUID}@@\"\n\nprint \"local UUID\" + uuid\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\npayload = {\"length\":500}\n\nbase_url = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/vms\"\nurl = base_url + \"\/\" + uuid\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"GET\"\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nvm_json = r.json()\n\ndel vm_json['status']\nvm_json['metadata']['categories'] = {}\n\nprint \"Categories: \" + json.dumps(vm_json['metadata']['categories'])\nprint \"VM JSON: \" + json.dumps(vm_json)\n\nurl = base_url + \"\/\" + str(vm_json['metadata']['uuid'])\nurl_method = \"PUT\"\nr = process_request(url, url_method, user, password, headers, json.dumps(vm_json))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"c8712657_runbook","main_task_local_reference":{"kind":"app_task","name":"306b2064_dag"},"variable_list":[]},"name":"Flow Del Category"}],"depends_on_list":[{"kind":"app_service","name":"Flow"}],"name":"Era","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CLEANUP_OPERATION_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CLUSTER_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"COMPUTE_PROF_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CREATE_OPERATION_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_ENTITY_NAME","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_PARAM_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_SERVER_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_SERVER_IP","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DEREGISTER_OPERATION_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NETWORK_PROF_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SLA_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SOFTWARE_PROF_ID","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_SERVER_NAME","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_SERVER_VM_UUID","value":"","label":"","attrs":{"type":""},"is_hidden":false}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Flow Add Category"}],"name":"6fba9cbb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Flow Add Category","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"c1103d1f_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"01945104_runbook","main_task_local_reference":{"kind":"app_task","name":"6fba9cbb_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8bee20f0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"fe42eb38_runbook","main_task_local_reference":{"kind":"app_task","name":"8bee20f0_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04cc6e24_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ffd25064_runbook","main_task_local_reference":{"kind":"app_task","name":"04cc6e24_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9d7e4dfb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ef6acd35_runbook","main_task_local_reference":{"kind":"app_task","name":"9d7e4dfb_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"897e9b24_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b81e8f8b_runbook","main_task_local_reference":{"kind":"app_task","name":"897e9b24_dag"},"variable_list":[]},"name":"action_stop"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"register epoch"},{"kind":"app_task","name":"install collector"}],"name":"304a6826_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"register epoch"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install collector"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"register epoch","attrs":{"exit_status":[],"script":"set -x \n\nsudo yum install -y wget\nsudo wget --no-check-certificate --header=\"userport: 443\" \\\n     -O \/usr\/bin\/install-epoch-collectors.sh https:\/\/@@{epoch_aoc_host}@@\/install_epoch_collectors\nsudo chmod +x \/usr\/bin\/install-epoch-collectors.sh \\\n     && EPOCH_ANALYSIS_DEPTH=layer7 EPOCH_AOC_HOST=@@{epoch_aoc_host}@@ \\\n     EPOCH_ORGANIZATION_ID=@@{epoch_org_id}@@ EPOCH_ANALYSIS_DEPTH=layer4 \\\n     EPOCH_AUTOUPGRADE_COLLECTORS=no EPOCH_PKG_REPO_PORT=@@{download_port}@@ \\\n     EPOCH_PKG_REPO_HOST=@@{download_host}@@ \/usr\/bin\/install-epoch-collectors.sh\nsudo \/etc\/init.d\/epoch-collectors restart","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"install collector","attrs":{"exit_status":[],"script":"set -x \n\necho \"Install postgres database Collector\"\necho \"init_config:\ninstances:\n  - host: localhost\n    port: 5432\n    username: postgres\n    password: postgres\n    dbname: @@{db_name}@@\n\" | sudo tee \/etc\/nutanix\/epoch-dd-agent\/conf.d\/postgres.yaml\n\nsudo cp \/dev\/null \/var\/log\/nutanix\/epoch-ddagent\/collector.log\nsudo \/etc\/init.d\/epoch-collectors stop\nsudo EPOCH_ANALYSIS_DEPTH=layer7 \/opt\/nutanix\/epoch\/collectors\/configure.sh\nsudo \/etc\/init.d\/epoch-collectors restart\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"d8232a1b_runbook","main_task_local_reference":{"kind":"app_task","name":"304a6826_dag"},"variable_list":[]},"name":"Epoch Registration"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Add Category Value"}],"name":"4d167183_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Add Category Value","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\ndbname = \"@@{Era.DB_SERVER_NAME}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\npayload = {\"length\":500}\n\nbase_url = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/vms\"\nurl = base_url + \"\/list\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nvm_list_json = r.json()\nfor vm in vm_list_json['entities']:\n  if vm['spec']: #sometimes this value will be '{}'\n    if (vm['spec']['name'] == dbname):\n      uuid = vm['metadata']['uuid']\n\nprint \"uuid is: \" + uuid\nprint \"VM_UUID is: \" + \"@@{Era.DB_SERVER_VM_UUID}@@\"\n\n#using GET instead of '\/list'\nurl = base_url + \"\/\" + str(uuid)\nurl_method = \"GET\"\nr = process_request(url, url_method, user, password, headers, '')\nprint \"Response Status: \" + str(r.status_code)\nvm_json = r.json()\nprint \"GET: \" + json.dumps(vm_json)\n\ndel vm_json['status']\nvm_json['metadata']['categories']['Environment'] = \"@@{calm_application_name}@@\"\nvm_json['metadata']['categories']['AppTier'] = \"DB\"\nvm_json['metadata']['categories']['AppType'] = \"Default\"\n\nprint \"Categories: \" + json.dumps(vm_json['metadata']['categories'])\nprint \"VM JSON: \" + json.dumps(vm_json)\n\nurl = base_url + \"\/\" + str(vm_json['metadata']['uuid'])\nurl_method = \"PUT\"\nr = process_request(url, url_method, user, password, headers, json.dumps(vm_json))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"c1103d1f_runbook","main_task_local_reference":{"kind":"app_task","name":"4d167183_dag"},"variable_list":[]},"name":"Flow Add Category"}],"depends_on_list":[{"kind":"app_service","name":"Flow"}],"name":"Postgres","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"UUID","value":"","label":"","attrs":{"type":""},"is_hidden":false}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Flow Add Category"}],"name":"e85e4bfd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Flow Add Category","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"2513cb58_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"689f007f_runbook","main_task_local_reference":{"kind":"app_task","name":"e85e4bfd_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Flow Del Category"}],"name":"cdac52fd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Flow Del Category","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"07193241_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"5c68fe48_runbook","main_task_local_reference":{"kind":"app_task","name":"cdac52fd_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"013f3a99_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b7f7ecc1_runbook","main_task_local_reference":{"kind":"app_task","name":"013f3a99_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b59ae8b2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"dcd5097d_runbook","main_task_local_reference":{"kind":"app_task","name":"b59ae8b2_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04211cd7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c51f15d2_runbook","main_task_local_reference":{"kind":"app_task","name":"04211cd7_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"register epoch"},{"kind":"app_task","name":"install collector"}],"name":"9e24659d_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"register epoch"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install collector"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"register epoch","attrs":{"exit_status":[],"script":"set -x \n\nsudo hostnamectl set-hostname @@{name}@@-$RANDOM\nsudo yum install -y wget\nsudo wget --no-check-certificate --header=\"userport: 443\" \\\n     -O \/usr\/bin\/install-epoch-collectors.sh https:\/\/@@{epoch_aoc_host}@@\/install_epoch_collectors\nsudo chmod +x \/usr\/bin\/install-epoch-collectors.sh \\\n     && EPOCH_ANALYSIS_DEPTH=layer7 EPOCH_AOC_HOST=@@{epoch_aoc_host}@@ \\\n     EPOCH_ORGANIZATION_ID=@@{epoch_org_id}@@ EPOCH_ANALYSIS_DEPTH=layer4 \\\n     EPOCH_AUTOUPGRADE_COLLECTORS=no EPOCH_PKG_REPO_PORT=@@{download_port}@@ \\\n     EPOCH_PKG_REPO_HOST=@@{download_host}@@ \/usr\/bin\/install-epoch-collectors.sh\nsudo \/etc\/init.d\/epoch-collectors restart","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"install collector","attrs":{"exit_status":[],"script":"set -x \n\necho \"Install docker daemon Collector\"\necho \"init_config:\ninstances:\n  - ## Daemon and system configuration\n    url: unix:\/\/run\/containerd\/containerd.sock\n\" | sudo tee \/etc\/nutanix\/epoch-dd-agent\/conf.d\/docker_daemon.yaml\n\nsudo -E usermod -a -G docker epoch-dd-agent\n\nsudo cp \/dev\/null \/var\/log\/nutanix\/epoch-ddagent\/collector.log\nsudo \/etc\/init.d\/epoch-collectors stop\nsudo EPOCH_ANALYSIS_DEPTH=layer7 \/opt\/nutanix\/epoch\/collectors\/configure.sh\nsudo \/etc\/init.d\/epoch-collectors restart\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a9b6a0ad_runbook","main_task_local_reference":{"kind":"app_task","name":"9e24659d_dag"},"variable_list":[]},"name":"Epoch Registration"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Add Category Value"}],"name":"0ee728cb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Add Category Value","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\npayload = {\"length\":500}\n\nbase_url = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/vms\"\nurl = base_url + \"\/list\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nvm_list_json = r.json()\nfor vm in vm_list_json['entities']:\n  if vm['spec']: #sometimes this value will be '{}'\n    if (vm['spec']['name'] == \"@@{name}@@\"):\n      vm_json = vm\n\ndel vm_json['status']\nvm_json['metadata']['categories']['Environment'] = \"@@{calm_application_name}@@\"\nvm_json['metadata']['categories']['AppTier'] = \"App\"\nvm_json['metadata']['categories']['AppType'] = \"Default\"\n\nprint \"Categories: \" + json.dumps(vm_json['metadata']['categories'])\nprint \"VM JSON: \" + json.dumps(vm_json)\n\nurl = base_url + \"\/\" + str(vm_json['metadata']['uuid'])\nurl_method = \"PUT\"\nr = process_request(url, url_method, user, password, headers, json.dumps(vm_json))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"2513cb58_runbook","main_task_local_reference":{"kind":"app_task","name":"0ee728cb_dag"},"variable_list":[]},"name":"Flow Add Category"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Del Category Value"}],"name":"f6c17c1d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Del Category Value","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\npayload = {\"length\":500}\n\nbase_url = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/vms\"\nurl = base_url + \"\/list\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nvm_list_json = r.json()\nfor vm in vm_list_json['entities']:\n  if vm['spec']: #sometimes this value will be '{}'\n    if (vm['spec']['name'] == \"@@{name}@@\"):\n      vm_json = vm\n\ndel vm_json['status']\nvm_json['metadata']['categories'] = {}\n\nprint \"Categories: \" + json.dumps(vm_json['metadata']['categories'])\nprint \"VM JSON: \" + json.dumps(vm_json)\n\nurl = base_url + \"\/\" + str(vm_json['metadata']['uuid'])\nurl_method = \"PUT\"\nr = process_request(url, url_method, user, password, headers, json.dumps(vm_json))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"07193241_runbook","main_task_local_reference":{"kind":"app_task","name":"f6c17c1d_dag"},"variable_list":[]},"name":"Flow Del Category"}],"depends_on_list":[{"kind":"app_service","name":"Flow"}],"name":"app","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"90c0c5e3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"92b6d4f0_runbook","main_task_local_reference":{"kind":"app_task","name":"90c0c5e3_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"eb4b50c2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"62bd3161_runbook","main_task_local_reference":{"kind":"app_task","name":"eb4b50c2_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a2c2f1cf_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"65935808_runbook","main_task_local_reference":{"kind":"app_task","name":"a2c2f1cf_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2ac813b0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"5c0f6744_runbook","main_task_local_reference":{"kind":"app_task","name":"2ac813b0_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"84fb7f0b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"88bdd252_runbook","main_task_local_reference":{"kind":"app_task","name":"84fb7f0b_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"CreateCategory"}],"name":"78bc726b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateCategory","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\n\n#AppTier\/App if not existed\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/categories\/AppTier\/App\"\nurl_method = \"PUT\"\npayload = {\"value\": \"App\",\"description\":\"App\"}\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n\n#AppTier\/DB if not existed\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/categories\/AppTier\/DB\"\nurl_method = \"PUT\"\npayload = {\"value\": \"DB\",\"description\":\"DB\"}\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n\n#environment\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/categories\/Environment\/@@{calm_application_name}@@\"\nurl_method = \"PUT\"\npayload = {\"value\": \"@@{calm_application_name}@@\",\"description\":\"@@{calm_application_name}@@ environment\"}\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n\n\n\n\n\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"3b58a035_runbook","main_task_local_reference":{"kind":"app_task","name":"78bc726b_dag"},"variable_list":[]},"name":"Create Category"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"CreatePolicy1"},{"kind":"app_task","name":"CreatePolicy2"}],"name":"2c84755f_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"CreatePolicy1"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CreatePolicy2"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreatePolicy1","attrs":{"exit_status":[],"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/network_security_rules\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\npayload = {\n    \"metadata\": {\n        \"kind\": \"network_security_rule\",\n        \"categories\": {},\n        \"spec_version\": 0\n    },\n    \"spec\": {\n        \"description\": \"@@{calm_application_name}@@\",\n        \"resources\": {\n            \"app_rule\": {\n                \"action\": \"MONITOR\",\n                \"outbound_allow_list\": [],\n                \"target_group\": {\n                    \"filter\": {\n                        \"params\": {\n                            \"Environment\": [\n                                \"@@{calm_application_name}@@\"\n                            ],\n                            \"AppType\": [\n                                \"Default\"\n                            ],\n                            \"AppTier\": [\n                                \"DB\"\n                            ]\n                        },\n                        \"kind_list\": [\n                            \"vm\"\n                        ],\n                        \"type\": \"CATEGORIES_MATCH_ALL\"\n                    },\n                    \"default_internal_policy\": \"ALLOW_ALL\",\n                    \"peer_specification_type\": \"FILTER\"\n                },\n                \"inbound_allow_list\": [\n                    {\n                        \"filter\": {\n                            \"params\": {\n                                \"Environment\": [\n                                    \"@@{calm_application_name}@@\"\n                                ],\n                                \"AppType\": [\n                                    \"Default\"\n                                ],\n                                \"AppTier\": [\n                                    \"App\"\n                                ]\n                            },\n                            \"kind_list\": [\n                                \"vm\"\n                            ],\n                            \"type\": \"CATEGORIES_MATCH_ALL\"\n                        },\n                        \"tcp_port_range_list\": [\n                            {\n                                \"end_port\": 5432,\n                                \"start_port\": 5432\n                            }\n                        ],\n                        \"protocol\": \"TCP\",\n                        \"peer_specification_type\": \"FILTER\"\n                    },\n                    {\n                        \"filter\": {\n                            \"params\": {\n                                \"Environment\": [\n                                    \"@@{calm_application_name}@@\"\n                                ],\n                                \"AppType\": [\n                                    \"Default\"\n                                ],\n                                \"AppTier\": [\n                                    \"App\"\n                                ]\n                            },\n                            \"kind_list\": [\n                                \"vm\"\n                            ],\n                            \"type\": \"CATEGORIES_MATCH_ALL\"\n                        },\n                        \"protocol\": \"UDP\",\n                        \"udp_port_range_list\": [\n                            {\n                                \"end_port\": 5432,\n                                \"start_port\": 5432\n                            }\n                        ],\n                        \"peer_specification_type\": \"FILTER\"\n                    }\n                ]\n            }\n        },\n        \"name\": \"@@{calm_application_name}@@\"\n    }\n}\n\n\n\nprint \"Payload: \" + json.dumps(payload)\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n\nprint \"policy_uuid_1=\", r.json()['metadata']['uuid']\n","eval_variables":["policy_uuid_1"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreatePolicy2","attrs":{"exit_status":[],"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/network_security_rules\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\npayload = {\n    \"metadata\": {\n        \"kind\": \"network_security_rule\",\n        \"spec_version\": 0,\n        \"categories\": {}\n    },\n    \"spec\": {\n        \"description\": \"@@{calm_application_name}@@\",\n        \"resources\": {\n            \"app_rule\": {\n                \"action\": \"MONITOR\",\n                \"outbound_allow_list\": [\n                    {\n                        \"filter\": {\n                            \"params\": {\n                                \"Environment\": [\n                                    \"@@{calm_application_name}@@\"\n                                ],\n                                \"AppType\": [\n                                    \"Default\"\n                                ],\n                                \"AppTier\": [\n                                    \"DB\"\n                                ]\n                            },\n                            \"kind_list\": [\n                                \"vm\"\n                            ],\n                            \"type\": \"CATEGORIES_MATCH_ALL\"\n                        },\n                        \"tcp_port_range_list\": [\n                            {\n                                \"end_port\": 5432,\n                                \"start_port\": 5432\n                            }\n                        ],\n                        \"protocol\": \"TCP\",\n                        \"peer_specification_type\": \"FILTER\"\n                    },\n                    {\n                        \"filter\": {\n                            \"params\": {\n                                \"Environment\": [\n                                    \"@@{calm_application_name}@@\"\n                                ],\n                                \"AppType\": [\n                                    \"Default\"\n                                ],\n                                \"AppTier\": [\n                                    \"DB\"\n                                ]\n                            },\n                            \"kind_list\": [\n                                \"vm\"\n                            ],\n                            \"type\": \"CATEGORIES_MATCH_ALL\"\n                        },\n                        \"protocol\": \"UDP\",\n                        \"udp_port_range_list\": [\n                            {\n                                \"end_port\": 5432,\n                                \"start_port\": 5432\n                            }\n                        ],\n                        \"peer_specification_type\": \"FILTER\"\n                    }\n                ],\n                \"target_group\": {\n                    \"filter\": {\n                        \"params\": {\n                            \"Environment\": [\n                                \"@@{calm_application_name}@@\"\n                            ],\n                            \"AppType\": [\n                                \"Default\"\n                            ],\n                            \"AppTier\": [\n                                \"App\"\n                            ]\n                        },\n                        \"kind_list\": [\n                            \"vm\"\n                        ],\n                        \"type\": \"CATEGORIES_MATCH_ALL\"\n                    },\n                    \"default_internal_policy\": \"ALLOW_ALL\",\n                    \"peer_specification_type\": \"FILTER\"\n                },\n                \"inbound_allow_list\": [\n                    {\n                        \"ip_subnet\": {\n                            \"ip\": \"@@{pc_ip}@@\",\n                            \"prefix_length\": 32\n                        },\n                        \"protocol\": \"ALL\",\n                        \"peer_specification_type\": \"IP_SUBNET\"\n                    },\n                    {\n                        \"ip_subnet\": {\n                            \"ip\": \"@@{era_ip}@@\",\n                            \"prefix_length\": 32\n                        },\n                        \"protocol\": \"ALL\",\n                        \"peer_specification_type\": \"IP_SUBNET\"\n                    },\n                    {\n                        \"ip_subnet\": {\n                            \"ip\": \"0.0.0.0\",\n                            \"prefix_length\": 0\n                        },\n                        \"tcp_port_range_list\": [\n                            {\n                                \"end_port\": 80,\n                                \"start_port\": 80\n                            },\n                            {\n                                \"end_port\": 8080,\n                                \"start_port\": 8080\n                            },\n                            {\n                                \"end_port\": 8000,\n                                \"start_port\": 8000\n                            }\n                        ],\n                        \"protocol\": \"TCP\",\n                        \"peer_specification_type\": \"IP_SUBNET\"\n                    }\n                ]\n            }\n        },\n        \"name\": \"@@{calm_application_name}@@\"\n    }\n}\n\n\n\nprint \"Payload: \" + json.dumps(payload)\n\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\n\nprint \"policy_uuid_2=\", r.json()['metadata']['uuid']\n","eval_variables":["policy_uuid_2"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"172074d8_runbook","main_task_local_reference":{"kind":"app_task","name":"2c84755f_dag"},"variable_list":[]},"name":"Create Policy"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"DeletePolicy"}],"name":"27a19187_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DeletePolicy","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/network_security_rules\/@@{policy_uuid_1}@@\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"DELETE\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/network_security_rules\/@@{policy_uuid_2}@@\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"b0ce783a_runbook","main_task_local_reference":{"kind":"app_task","name":"27a19187_dag"},"variable_list":[]},"name":"Delete Policy"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"DeleteCategory"}],"name":"d0b36d6d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DeleteCategory","attrs":{"script":"user = \"@@{pc_username}@@\"\npassword = \"@@{pc_password}@@\"\nip = \"@@{pc_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v3\/categories\/Environment\/@@{calm_application_name}@@\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"DELETE\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"771ebc6f_runbook","main_task_local_reference":{"kind":"app_task","name":"d0b36d6d_dag"},"variable_list":[]},"name":"Delete Category"}],"depends_on_list":[],"name":"Flow","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"policy_uuid_1","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"policy_uuid_2","value":"","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"policy_uuid_3","value":"","label":"","attrs":{"type":""},"is_hidden":false}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"EraServer","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":true,"address":"@@{ip_address}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"era_creds"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{era_ip}@@"},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"Era_PostgreSQL_DB","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{ip_address}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"db_server_creds"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{Era.DB_SERVER_IP}@@"},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"VM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"integration-@@{calm_array_index}@@-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"3c31b474-c3ee-480b-957e-cff8fb9d2e19"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\ndisable_root: False\nssh_enabled: True\nssh_pwauth: True\nusers:\n  - name: centos\n    ssh-authorized-keys:\n      - @@{db_public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS_1CD","uuid":"cf6783d7-11ec-4c7c-a378-972c7464bbd8"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"FlowIngegration","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":true,"address":"@@{ip_address}@@","delay_secs":"60","connection_port":22},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"0.0.0.0"},"variable_list":[]}],"credential_definition_list":[{"username":"era","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"db_server_creds"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"era_creds"},{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"centos"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Era"}],"name":"EraPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"EraPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"GetClusterID"},{"kind":"app_task","name":"GetProfileIDs"},{"kind":"app_task","name":"GetSLAID"},{"kind":"app_task","name":"ProvisionDB"},{"kind":"app_task","name":"MonitorOperation"},{"kind":"app_task","name":"GetDatabaseInfo"}],"name":"7bd63f34_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"GetClusterID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"GetProfileIDs"}},{"from_task_reference":{"kind":"app_task","name":"GetProfileIDs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"GetSLAID"}},{"from_task_reference":{"kind":"app_task","name":"GetSLAID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"ProvisionDB"}},{"from_task_reference":{"kind":"app_task","name":"MonitorOperation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"GetDatabaseInfo"}},{"from_task_reference":{"kind":"app_task","name":"ProvisionDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorOperation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"GetClusterID","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Cluster ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/clusters\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"CLUSTER_ID={0}\".format(json.loads(resp.content)[0]['id'])","eval_variables":["CLUSTER_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"GetProfileIDs","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get Software Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Software&name=@@{software_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"SOFTWARE_PROF_ID={0}\".format(json.loads(resp.content)['id'])\n\n# Get Compute Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Compute&name=@@{compute_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"COMPUTE_PROF_ID={0}\".format(json.loads(resp.content)['id'])\n\n# Get Compute Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Network&name=@@{network_profile}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\n\n# Get Compute Profile ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/profiles?type=Database_Parameter&name=@@{database_parameter}@@\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"DB_PARAM_ID={0}\".format(json.loads(resp.content)['id'])","eval_variables":["COMPUTE_PROF_ID","DB_PARAM_ID","NETWORK_PROF_ID","SOFTWARE_PROF_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"GetSLAID","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get the list of SLAs\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/slas\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n\n# Find the desired SLA, and set the corresponding ID to the variable\nfor sla in json.loads(resp.content):\n  if sla['name'] == \"@@{sla_name}@@\":\n    print \"SLA_ID={0}\".format(sla['id'])","eval_variables":["SLA_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"ProvisionDB","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Set the URL and payload\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/provision\"\npayload = {\n  \"databaseName\": \"@@{db_name}@@\",\n  \"databaseType\": \"postgres_database\",\n  \"databaseDescription\": \"Postgres database provisioned by Calm Application @@{calm_application_name}@@\",\n  \"clusterId\": \"@@{CLUSTER_ID}@@\",\n  \"softwareProfileId\": \"@@{SOFTWARE_PROF_ID}@@\",\n  \"computeProfileId\": \"@@{COMPUTE_PROF_ID}@@\",\n  \"networkProfileId\": \"@@{NETWORK_PROF_ID}@@\",\n  \"dbParameterProfileId\": \"@@{DB_PARAM_ID}@@\",\n  \"provisionInfo\": [\n    {\n      \"name\": \"application_type\",\n      \"value\": \"postgres_database\"\n    },\n    {\n      \"name\": \"listener_port\",\n      \"value\": \"5432\"\n    },\n    {\n      \"name\": \"database_size\",\n      \"value\": \"200\"\n    },\n    {\n      \"name\": \"working_dir\",\n      \"value\": \"\/tmp\"\n    },\n    {\n      \"name\": \"auto_tune_staging_drive\",\n      \"value\": True\n    },\n    {\n      \"name\": \"db_password\",\n      \"value\": \"@@{db_password}@@\"\n    },\n    {\n      \"name\": \"dbserver_name\",\n      \"value\": \"PostgreSQL-@@{calm_time}@@\"\n    },\n    {\n      \"name\": \"dbserver_description\",\n      \"value\": \"Postgres database server provisioned by Calm Application @@{calm_application_name}@@\"\n    },\n    {\n      \"name\": \"ssh_public_key\",\n      \"value\": \"@@{db_public_key}@@\"\n    }\n  ],\n  \"timeMachineInfo\": {\n    \"name\": \"PostgreSQL-@@{calm_time}@@_TM\",\n    \"description\": \"PostgreSQL-@@{calm_time}@@ time machine\",\n    \"slaId\": \"@@{SLA_ID}@@\",\n    \"schedule\": {\n      \"continuousSchedule\": {\n        \"enabled\": True,\n        \"logBackupInterval\": 30,\n        \"snapshotsPerDay\": 30\n      },\n      \"snapshotTimeOfDay\": {\n        \"hours\": 1,\n        \"minutes\": 0,\n        \"seconds\": 0\n      },\n      \"weeklySchedule\": {\n        \"enabled\": True,\n        \"dayOfWeek\": \"SUNDAY\"\n      },\n      \"monthlySchedule\": {\n        \"enabled\": True,\n        \"dayOfMonth\": 1\n      },\n      \"quartelySchedule\": {\n        \"enabled\": True,\n        \"startMonth\": \"JANUARY\",\n        \"dayOfMonth\": 1\n      },\n      \"yearlySchedule\": {\n        \"enabled\": False,\n        \"month\": \"DECEMBER\",\n        \"dayOfMonth\": 1\n      }\n    }\n  }\n}\n\n# Make the call and set the response operation ID to the variable\nresp = urlreq(url, verb='POST', auth='BASIC', user=era_user, passwd=era_pass, params=json.dumps(payload), headers=headers)\nprint \"CREATE_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])","eval_variables":["CREATE_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"MonitorOperation","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CREATE_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 60 seconds.\"\n  sleep(60)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 20 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  exit(1)\n\n# Get the newly provision DB Entity Name and set it to a variable\nprint \"DB_ENTITY_NAME={0}\".format(json.loads(resp.content)['entityName'])","eval_variables":["DB_ENTITY_NAME"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"GetDatabaseInfo","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Get DB Server IP and ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/name\/@@{DB_ENTITY_NAME}@@?detailed=true\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print json.dumps(json.loads(resp.content), indent=2)\nprint \"DB_SERVER_IP={0}\".format(json.loads(resp.content)['hostIP'])\nprint \"DB_ID={0}\".format(json.loads(resp.content)['id'])\nprint \"DB_SERVER_ID={0}\".format(json.loads(resp.content)['primaryHost'])\n\n# Get DB Server Name\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/dbservers\/\" + json.loads(resp.content)['primaryHost']\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print json.dumps(json.loads(resp.content), indent=2)\nprint \"DB_SERVER_NAME={0}\".format(json.loads(resp.content)['name'])\n\nprop = json.loads(resp.content)['properties']\nfor i in prop:\n  if i[\"name\"] == \"vm_cluster_uuid\":\n    print \"DB_SERVER_VM_UUID={0}\".format(i[\"value\"])\n","eval_variables":["DB_ID","DB_SERVER_ID","DB_SERVER_IP","DB_SERVER_NAME","DB_SERVER_VM_UUID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"a56589a3_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"7bd63f34_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"EraPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"CleanupDB"},{"kind":"app_task","name":"MonitorCleanupOp"},{"kind":"app_task","name":"DeregisterDBServer"},{"kind":"app_task","name":"MonitorDeregOp"}],"name":"99b487fd_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"CleanupDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorCleanupOp"}},{"from_task_reference":{"kind":"app_task","name":"DeregisterDBServer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MonitorDeregOp"}},{"from_task_reference":{"kind":"app_task","name":"MonitorCleanupOp"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"DeregisterDBServer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"CleanupDB","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/databases\/@@{DB_ID}@@?storage-cleanup=true&tm-cleanup=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"CLEANUP_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])","eval_variables":["CLEANUP_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"MonitorCleanupOp","state":"ACTIVE","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{CLEANUP_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"DeregisterDBServer","state":"ACTIVE","attrs":{"exit_status":[],"script":"# Set creds and headers\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\n\n# Cleanup the DB and get Operation ID\nurl = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/dbservers\/@@{DB_SERVER_ID}@@?soft-remove=false&remove=false&delete=true&delete-vm-snapshots=true&delete-vgs=true\"\nresp = urlreq(url, verb='DELETE', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\nprint \"DEREGISTER_OPERATION_ID={0}\".format(json.loads(resp.content)['operationId'])","eval_variables":["DEREGISTER_OPERATION_ID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"MonitorDeregOp","state":"ACTIVE","attrs":{"script":"# Set creds, headers, and URL\nera_user = '@@{era_creds.username}@@'\nera_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nurl     = \"https:\/\/@@{era_ip}@@:8443\/era\/v0.8\/operations\/@@{DEREGISTER_OPERATION_ID}@@\"\n\n# Monitor the operation\nfor x in range(20):\n  \n  print \"Sleeping for 30 seconds.\"\n  sleep(30)\n  resp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n  print \"Percentage Complete: {0}\".format(json.loads(resp.content)['percentageComplete'])\n  \n  # If complete, break out of loop\n  if json.loads(resp.content)['percentageComplete'] == \"100\":\n    break    \n\n# If the operation did not complete within 10 minutes, assume it's not successful and error out\nif json.loads(resp.content)['percentageComplete'] != \"100\":\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a8f36ab1_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"99b487fd_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Postgres"}],"name":"Package2","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"58ca4a03_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8b1f1a7b_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"58ca4a03_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"ee8bedbe_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"faacff5d_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"ee8bedbe_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"app"}],"name":"Package3","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package3"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"AppInstall"}],"name":"7886481e_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"AppInstall","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nset -x\nsudo yum install -y https:\/\/dl.fedoraproject.org\/pub\/epel\/epel-release-latest-7.noarch.rpm\n\n##option 1\n#sudo yum install -y yum-utils device-mapper-persistent-data lvm2\n#sudo yum-config-manager --add-repo https:\/\/download.docker.com\/linux\/centos\/docker-ce.repo\n#sudo yum install -y docker-ce docker-ce-cli containerd.io\n#sudo systemctl enable docker\n#sudo systemctl start docker\n#sudo -E usermod -a -G docker ${USER}\n#\n#sudo curl -L https:\/\/github.com\/docker\/compose\/releases\/download\/1.17.0\/docker-compose-`uname -s`-`uname -m` -o \/usr\/local\/bin\/docker-compose\n#sudo chmod +x \/usr\/local\/bin\/docker-compose\n#\n##sudo docker image pull michaelatnutanix\/oscar_jet:latest\n\n#option 2\nsudo yum install -y git  python-virtualenvwrapper python34 python34-devel postgresql-devel npm sshpass #python-virtualenv #python34-psycopg2\nsudo yum groupinstall -y \"Development Tools\"\nsudo yum install -y python2-pip.noarch python34-pip.noarch\nsource \/usr\/bin\/virtualenvwrapper.sh\n\ngit clone https:\/\/github.com\/panlm\/NutanixCloudNative-Oscar.git\ncd NutanixCloudNative-Oscar\n\nmkvirtualenv --python=python3.4 oscar\nvirtualenv oscar\n\necho \"\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql_psycopg2',\n        'NAME': '@@{Era.DB_ENTITY_NAME}@@',\n        'USER': 'postgres',\n        'PASSWORD': '@@{db_password}@@',\n        'HOST': '@@{Era.DB_SERVER_IP}@@',\n        'PORT': '',\n    }\n}\n\" |tee sandbox\/settings_local.py\n\nsudo pip3.4 install --upgrade setuptools\nsudo pip3.4 install --upgrade pip\n\nmake sandbox\n\n#virtualenv oscar\n#source ~\/.virtualenvs\/oscar\/bin\/activate\nnohup sandbox\/manage.py runserver 0.0.0.0:8000 &\n\nsleep 15\n\n#echo 'nutanix\/4u' |sudo passwd centos --stdin\n#rm -f ~\/.ssh\/known_hosts\n#ln -sf \/dev\/null ~\/.ssh\/known_hosts\n#export SSH_OPTS='-o StrictHostKeyChecking=no -o GlobalKnownHostsFile=\/dev\/null -o UserKnownHostsFile=\/dev\/null'\n#sshpass -p nutanix\/4u ssh -L 0.0.0.0:8080:127.0.0.1:8000 ${SSH_OPTS} -f localhost -N\n\nexit 0\n\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"3defcb2a_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"7886481e_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package3"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"d8357a3a_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"476ce5f9_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"d8357a3a_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Flow"}],"name":"Package4","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package4"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Category"},{"kind":"app_task","name":"Create Policy"}],"name":"ea12c7be_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create Category"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Policy"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Create Category","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"3b58a035_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Create Policy","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"172074d8_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"0ebc908d_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"ea12c7be_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package4"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete Policy"},{"kind":"app_task","name":"Delete Category"}],"name":"c75d107a_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Delete Policy"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Delete Category"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Delete Policy","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"b0ce783a_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Delete Category","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"771ebc6f_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"2e52a8a4_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"c75d107a_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"f6be2786_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package2"}],"substrate_local_reference":{"kind":"app_substrate","name":"Era_PostgreSQL_DB"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"f9a4c530_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"EraPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"EraServer"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"0f21b5e2_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package3"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"17264844_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package4"}],"substrate_local_reference":{"kind":"app_substrate","name":"FlowIngegration"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"},{"kind":"app_task","name":"Task2"},{"kind":"app_task","name":"Task3"},{"kind":"app_task","name":"Task4"}],"name":"c1a51ce5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Era"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"type":"","interval_secs":120},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Postgres"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task2","attrs":{"type":"","interval_secs":120},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"app"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task3","attrs":{"type":"","interval_secs":120},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Flow"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task4","attrs":{"type":"","interval_secs":120},"timeout_secs":"0","type":"DELAY","variable_list":[]}],"description":"","name":"21a8f06f_runbook","main_task_local_reference":{"kind":"app_task","name":"c1a51ce5_dag"},"variable_list":[]},"name":"Useless Action"}],"name":"Default","variable_list":[{"regex":{"should_validate":true,"value":"[Dd][Ee][Ff][Aa][Uu][Ll][Tt].*"},"val_type":"STRING","is_mandatory":true,"description":"select DEFAULT_OOB_COMPUTE","data_type":"BASE","type":"EXEC_LOCAL","name":"compute_profile","value":"","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"# Set creds and headers\n#era_user = '@@{era_creds.username}@@'\n#era_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nera_user = 'admin'\nera_pass = 'nutanix\/4u'\nera_ip = '10.42.62.44'\n\n# Get Compute Profile ID\nurl     = \"https:\/\/\" + era_ip + \":8443\/era\/v0.8\/profiles?type=Compute\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\na = ''\nfor i in resp.json():\n  a = a + i['name'] + ','\nprint re.sub(',$', '', a)","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}},{"regex":{"should_validate":true,"value":".*[Pp][Oo][Ss][Tt][Gg][Rr][Ee][Ss].*"},"val_type":"STRING","is_mandatory":true,"description":"select relevant to POSTGRES","data_type":"BASE","type":"EXEC_LOCAL","name":"database_parameter","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"# Set creds and headers\n#era_user = '@@{era_creds.username}@@'\n#era_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nera_user = 'admin'\nera_pass = 'nutanix\/4u'\nera_ip = '10.42.62.44'\n\n# Get Compute Profile ID\nurl     = \"https:\/\/\" + era_ip + \":8443\/era\/v0.8\/profiles?type=Database_Parameter\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\na = ''\nfor i in resp.json():\n  a = a + i['name'] + ','\nprint re.sub(',$', '', a)","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"db_name","value":"oscar_django_@@{calm_time(\"%Y%m%d%H%M\")}@@","label":"","is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"db_password","value":"nutanix","label":"","is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"db_public_key","value":"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCy9+19bVdjN2Uet\/jCZD7S+0GQBlv0eOu2tcKqx5p\/wWhfiT8ND0U3eklG1UlTTbRA+1sqBHkxoD0GdLsSV0Isr+3R3FlJgn7uhd0IzINjaN9PP7I2D4UATAvUpe13vqhsSxPEEahw9PeruyPABopZnZkhcqHE+x\/FHeBEf2daqmZ\/Yl5nlejUd5el49KkS+wKCjfwTmrIDYGbYAtq\/9uApdNxsyy9ECgVyuue5lIziXnV7R4\/ZPdOB+pZi7T4Sc7BytHW5C\/go0tPoA6jPkO19ZyDV9yz6iU4x2Ho7FROP3bxV3sZGmTM2jJrOcAd3Rosm2sJEaYxSP2TBrMKEFJL stevenpan@stevenpans-MacBook-Pro.local","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"10.42.62.44","label":"","attrs":{"type":"LOCAL"},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"sla_name","value":"GOLD","label":"","attrs":{"type":""},"is_hidden":false},{"regex":{"should_validate":true,"value":"[Pp][Oo][Ss][Tt][Gg][Rr][Ee][Ss].*"},"val_type":"STRING","is_mandatory":true,"description":"select relevant to POSTGRES (no HA)","data_type":"BASE","type":"EXEC_LOCAL","name":"software_profile","value":"","label":"","editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"# Set creds and headers\n#era_user = '@@{era_creds.username}@@'\n#era_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nera_user = 'admin'\nera_pass = 'nutanix\/4u'\nera_ip = '10.42.62.44'\n\n# Get Compute Profile ID\nurl     = \"https:\/\/\" + era_ip + \":8443\/era\/v0.8\/profiles?type=Software\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\na = ''\nfor i in resp.json():\n  a = a + i['name'] + ','\nprint re.sub(',$', '', a)","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"epoch_aoc_host","value":"nutanix.epoch.nutanix.com","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"epoch_org_id","value":"8cb44812-1cd3-45c4-847d-43f3271d126f","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"download_host","value":"","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"download_port","value":"","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pc_ip","value":"10.42.62.40","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"pc_username","value":"admin","label":"","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"pc_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"is_hidden":false},{"regex":{"should_validate":true,"value":"[Pp][Oo][Ss][Tt][Gg][Rr][Ee][Ss].*"},"val_type":"STRING","is_mandatory":true,"description":"select relevant to POSTGRES","data_type":"BASE","type":"EXEC_LOCAL","name":"network_profile","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"# Set creds and headers\n#era_user = '@@{era_creds.username}@@'\n#era_pass = '@@{era_creds.secret}@@'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json'}\nera_user = 'admin'\nera_pass = 'nutanix\/4u'\nera_ip = '10.42.62.44'\n\n# Get Compute Profile ID\nurl     = \"https:\/\/\" + era_ip + \":8443\/era\/v0.8\/profiles?type=Network\"\nresp = urlreq(url, verb='GET', auth='BASIC', user=era_user, passwd=era_pass, headers=headers)\n#print \"NETWORK_PROF_ID={0}\".format(json.loads(resp.content)['id'])\na = ''\nfor i in resp.json():\n  a = a + i['name'] + ','\nprint re.sub(',$', '', a)","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"centos"},"type":"USER"},"name":"integration-noEpoch"},"api_version":"3.0","metadata":{"last_update_time":"1572396588294400","kind":"blueprint","spec_version":30,"creation_time":"1571877056289167","name":"integration-noEpoch"}}